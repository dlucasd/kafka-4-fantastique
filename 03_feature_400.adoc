== 4.0.0

=== MÃ©triques clients via broker

image::images/metrics.svg[opts=inline, width=100%, height=500]


[.notes]
--
* problÃ¨me : pas d'interface standard, manque de visibilitÃ© sur les mÃ©triques applicatives
* *registerMetricForSubscription*(KafkaMetric metric) / *unregisterMetricFromSubscription*(KafkaMetric metric)
* RÃ©sultat: *observabilitÃ© â€œcomplÃ¨teâ€*
* Types de mÃ©triques limitÃ©s (sum/gauge) Sum : Compteur monotone (par exemple, nombre total de messages traitÃ©s). Gauge : Valeur non monotone (par exemple, taux de traitement).
--

[%notitle]
=== ImplÃ©mentation mÃ©trique

[.large-code-exemple]
--

[source,java,highlight=1..2|4..5|6..11|16..17]
----
Metrics local = new Metrics(new MetricConfig());
Sensor messageSensor = local.sensor("message-count-sensor");

LinkedHashMap<String, String> tags = new LinkedHashMap<>();
tags.put("component", "my-app");
MetricName metricName = new MetricName(
    "total-messages-processed",
    "application",
    "Total messages processed",
    tags
);

messageSensor.add(metricName, new CumulativeCount());
KafkaMetric metric = local.metrics().get(metricName);

consumer.registerMetricForSubscription(metric);
consumer.unregisterMetricFromSubscription(metric);
----

--

=== auto.offset.reset


image:images/resetOffsetDuration.svg[opts=inline, width=100%]

[.notes]
--
* Offset reset depuis une durÃ©e
* Tirer parti du stockage longue durÃ©e (tiered storage)pour reprendre â€œÃ  X temps en arriÃ¨reâ€
* usages : data analytics, reprise sur incident
* KIP-1106
--

=== Format ISO-8601

* PnDTnHnMn.nS
* Exemples:
** P30D â†’ 30 jours
** PT12H â†’ 12 heures
** P1DT30M â†’ 1 jour et 30 minutes


=== Rebalance


[%notitle]
=== Avant

image:images/classicRebalance.svg[opts=inline, width=80%]

[.notes]
--
* problÃ¨me : 
** "stop the world" = "synchronisation barrier"
** difficile de trouver la *root cause* car beaucoup d'Ã©changes
** s'il y a un *consumer qui a du lag* ? tout le groupe attend
--

[%notitle]
=== AprÃ¨s

image:images/consumerRebalance.svg[opts=inline, width=80%]

[%notitle.blue.background]
=== Perf consommation 

image:images/throughputRebalance.png[]

[.notes]
--
* provenance de l'Ã©tude : https://current.confluent.io/2024-sessions/the-performance-of-kafkas-new-consumer-rebalance-protocol
* production constante Ã  29 MB/s
* 1 consommateur *avec lag important* impacte tout le groupe
--
=== Consumer Group Protocol

[.step.without-bullets]
* ğŸ” Rebalance incrÃ©mental
* ğŸ¯ GÃ©rÃ© par le coordinator, facilite le dÃ©bug
* âš™ï¸ ActivÃ© par dÃ©faut cÃ´tÃ© serveur, cÃ´tÃ© client : `group.protocol=consumer`
* âš–ï¸ Compromis : usage CPU cÃ´tÃ© serveur, empreinte mÃ©moire plus Ã©levÃ©e
* ğŸ’» Outils d'admin : kafka-groups.sh, kafka-consumer-groups.sh


[.notes]
--
* ce n'est pas activÃ© par dÃ©faut car il faut que le consumer et broker soient tous les 2 en 4.0
* profite Ã©galement Ã  Kafka Connect car protocol conÃ§u de maniÃ¨re gÃ©nÃ©rique : il assigne des ressources Ã  des groupes
* KIP-848 - 4.0.0
--

=== Streams rebalance protocol

[.step.without-bullets]
* ğŸ§ª Early access en 4.1.0
* ğŸ§© Se base sur le Consumer Group Protocol
* ğŸ”€ MÃªme principe mais pour l'assignation des tÃ¢ches Kafka Streams

[.notes]
--
* KIP-1071
--

=== Queues

[.step]
en early access

[.notes]
--
* On se garde Ã§a pour plus tard car c'est en preview dans la 4.1.0
* KIP-1099
--
