== 4.1.0

=== MÃ©triques des plugins Kafka


[.notes]
--
* KIP-877
--

=== Qu'est-ce qu'un plugin Kafka ?

[.step]
* *Broker*: Authorizer, CreateTopicPolicy, ClientQuotaCallback, ReplicaSelector
* *Producer*: Serializer, Partitioner, ProducerInterceptor
* *Consumer*: Deserializer, ConsumerInterceptor
* *Connect*: Converter, Transform, Predicate, Connector, Task

[.notes]
--
* problÃ¨me : *pas de standard*, duplication de metriques, difficultÃ© Ã  associer mÃ©triques plugin/client
--

=== ImplÃ©mentation

[.large-code-exemple]
--


[source,java,highlight=1..2|6..13|15..19]
----
public class MyInterceptor<K, V> 
  implements ProducerInterceptor<K, V>, Monitorable {
  
  private Sensor sensor;

  @Override
  public void withPluginMetrics(PluginMetrics metrics) {
    sensor = metrics.sensor("onSend");
    MetricName rate  = metrics.metricName("rate",  "Average number of calls per second.", new LinkedHashMap<>());
    MetricName total = metrics.metricName("total", "Total number of calls.",             new LinkedHashMap<>());
    sensor.add(rate,  new Rate());
    sensor.add(total, new CumulativeCount());
  }

  @Override
  public ProducerRecord<K,V> onSend(ProducerRecord<K,V> record) {
    sensor.record();
    return record;
  }
}
----

--

[.notes]
--
* deux nouvelles interfaces : Monitorable et PluginMetrics
* facilitÃ© : mÃ©triques attachÃ©es au Metrics du composant hÃ´te, taguÃ©es automatiquement pour identifier le plugin.
* plus besoin de gÃ©rer les reporters : c'est fait automatiquement.
--

=== Migration mÃ©triques consumer

[.step]
* *ProblÃ¨me*:
** Producer: `topic.a.b` âœ…
** Consumer: `topic.a.b` â†’ `topic_a_b` âŒ

[.step]
* *Solution*:
** 4.x: Ajoute `topic.a.b` (nouveau) + conservation `topic_a_b` (dÃ©prÃ©ciÃ©)
** 5.0: Seulement `topic.a.b` ğŸ‰


[.notes]
--
* qui met des points dans les noms de ses topics ?
* problÃ¨me : les points sont *remplacÃ©s par des underscores*
* pourquoi ? *code legacy* pour s'*aligner avec le modÃ¨le de graphite*
* Identifiez vos dashboards avec `topic_a_b` et Migrez vers `topic.a.b` avant 5.0
* KIP-1109
--

=== OAuth2 grant type

[.step.without-bullets]
* â—ï¸ *ProblÃ¨me*: seul client_credentials supportÃ©
** Secret statique = Potentiel risque de sÃ©curitÃ©
[.step.without-bullets]
* ğŸ” *Solution*: jwt-bearer (RFC 7523)
** Authentification via JWT signÃ©

[.notes]
--
* Beaucoup d'IdP (cloud) n'*autorisent pas* client_credentials (secret statique)
* SÃ©curitÃ© + flexibilitÃ© (RBAC, multi-tenant)
* KIP-1139
--


=== Kafka Connect: support plugins multi-versions

[.step]
* *ProblÃ¨me*: 1 version par cluster
* DifficultÃ© Ã  gÃ©rer les montÃ©es de versions, rollback etc ...
* ğŸ›ï¸ *NouveautÃ©*: Support de plusieurs versions de plugins sur un cluster 

[.notes]
--
* plugin type connecteur postgresql, debezium, etc.
* Upgrades en 2 temps avec rollback facile
* RÃ©duction clusters Connect
* KIP-891 - 4.1.0
--

=== Installation

[source,bash,highlight=1..10|6..8]
----
opt/
  plugins/
    foo-connector-1.8/
      foo-connector-1.8.jar
      foo-dependencies-1.0.jar
    foo-connector-1.9/
      foo-connector-1.9.jar
      foo-dependencies-1.1.jar
    bar-connector/
      bar-connector-1.0.jar
----


=== Utilisation

[.step]
* SpÃ©cifier la version souhaitÃ©e
** `"xxx.plugin.version": "[3.5,)"`
* Versions visibles de maniÃ¨re distincte dans l'API

[.notes]
--
* notation maven range
* API mise Ã  jour
--

=== Queues for Kafka

[.step.without-bullets]
* Nouvelle maniÃ¨re de consommer un topic

=== Rappel consommateur classique

image:images/consumerClassic.svg[]

=== Rappel Point Ã  point / Queue

[.step.without-bullets]
* ğŸ‘¤ Message consommÃ© par un seul consommateur
* ğŸ”„ Traitement asynchrone
* âœ… Acquittement au message
* ğŸ—‘ï¸ Suppression du message aprÃ¨s traitement

[.notes]
--
* en *fonction de la configuration* du broker
* Non ce n'est pas ce qui a Ã©tÃ© implÃ©mentÃ©
--

=== Share Groups

[.step.without-bullets]
* ğŸ”§ API identique au consumer group
* â— Permet la consommation de messages d'*une seule partition* par plusieurs consommateurs
* âœ… Acquittement au message

[%notitle]
=== SchÃ©ma

image:images/shareConsumer.svg[]

[.notes]
--
* *plus de limite* de consommateurs par topic
* les deux types de consommateurs peuvent *cohabiter*
--


=== Acquittement

[.step]
* `share.acknowledgement.mode=implicit` (default) : acquittement automatique lors du poll()
* `share.acknowledgement.mode=explicit`

=== Explicite

[source,java,highlight=1..5|6..7|9..13|15..16|18..20|21..23]
----
@ï¸KafkaListener(
    topics = "order-processing",
    groupId = "order-processors",
    containerFactory = "shareKafkaListenerContainerFactory"
)
public void processOrder(OrderEvent event,
                         ShareAcknowledgment acknowledgment) {
  try {
    if (!isValid(event)) {
      log.info("Rejet du message, ne sera pas re-deliverÃ©");
      acknowledgment.reject();
      return;
    }

    orderService.process(event);
    acknowledgment.acknowledge();

  } catch (TransientException e) {
    log.info("Erreur temporaire, rejeu possible");
    acknowledgment.release();
  } catch (PermanentException e) {
    log.info("Rejet du message, ne sera pas re-deliverÃ©");
    acknowledgment.reject();
  }
}
----

[%notitle]
=== RecordState

image:images/recordState.svg[opts=inline, width=80%]


=== Nouvelles propriÃ©tÃ©s

[.step]
* `share.delivery.count.limit: 5`
* `share.record.lock.duration.ms: 30000` (30 sec)

=== Cas d'usage

[.step.without-bullets]
* âœ‰ï¸ NÃ©cessitÃ© d'acquittement au message avec rejeu/rejet
* ğŸ“ˆ Mise Ã  l'Ã©chelle sans garantie d'ordre
* ğŸ” Faciliter la migration de systÃ¨me type queue vers Kafka

=== Preview

[.step.without-bullets]
* ğŸš€ Production ready pour la 4.2.0
* ğŸ’» Outil d'admin : kafka-share-groups.sh
* ğŸ“¨ IntÃ©gration de Dead Letter Queue
* â“ Garantie d'ordre en rÃ©flexion

[.notes]
--
* KIP-932 
--

